<!doctype html>
<html>
<head>
    <title></title>
    <meta charset="UTF-8"/>
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,user-scalable=no">
    <!--<link rel="stylesheet" href="lib/jqueryui/jquery-ui.min.css">-->
    <!--<link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">-->
    <script src="face-api.js"></script>
    <script src="js/commons.js"></script>
    <script src="js/faceDetectionControls.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>

    <link rel="stylesheet" href="css/zui.min.css">
    <link rel="stylesheet" href="css/normal.css">
    <link rel="stylesheet" href="css/animate.css" >
    <link rel="stylesheet" href="lib/calendar/zui.calendar.css">
    <link rel="stylesheet" href="lib/datatable/zui.datatable.css">
    <link rel="stylesheet" href="lib/datetimepicker/datetimepicker.css">
    <link rel="stylesheet" href="lib/kindeditor/kindeditor.css">
    <link rel="stylesheet" href="demos.css">

</head>
<body class="v_royal_blue">

<script src="js/zui.min.js"></script>
<script src="js/mustache.js" type="text/javascript" charset="utf-8"></script>
<!--<script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>-->
<script src="js/underscore-min.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak=LTxUaMMGw5ScN9D6zKZHD8zq4wG28jS1">
</script>
<script src="lib/calendar/zui.calendar.min.js"></script>
<script src="lib/datatable/zui.datatable.js"></script>
<script src="lib/datetimepicker/datetimepicker.min.js"></script>
<script src="lib/kindeditor/kindeditor.min.js"></script>
<script src="lib/jqueryui/jquery-ui.min.js"></script>

<script src="lib/particles.min.js"></script>
<script src="js/mapv.js" type="text/javascript" charset="utf-8"></script>

<script src="lib/selectable/zui.selectable.min.js"></script>
<link rel="stylesheet" href="lib/hivideo/assets/hivideo.css"/>
<link rel="stylesheet" href="css/style.css">
<script type="text/javascript" src="lib/hivideo/hivideo.js"></script>
<script src="js/client.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="js/bind_config.js"></script>

<script>
    var byId = function (id) {
        return document.getElementById(id);
    };

    function next(){
        console.log("next");


        var _id = localStorage.getItem("_id");
        if(!_id)
        {
            _id = 1;
        }
        else{
            _id = parseInt(_id) + 1;
        }
        var chart_pie = echarts.init(byId('chart_pie'));
        client.get(client.devHost + client.newData, {_id: _id}, function(result){
//            console.log(result);
            localStorage.setItem("_id", result._id);
            localStorage.setItem("scene", JSON.stringify(result));
            var dataScene = [];
            for(var i in result.scene)
            {
                dataScene.push({value: result.scene[i][0], name: result.scene[i][1]});
            }
//            console.log(dataScene);
            var op = getOptionPie('bar', dataScene);

            chart_pie.setOption(op);
        });

    }
</script>

<div id="loader-wrapper">
    <div id="loading-center-absolute">
        <div class="object" id="object_four"></div>
        <div class="object" id="object_three"></div>
        <div class="object" id="object_two"></div>
        <div class="object" id="object_one"></div>
    </div>
    <div class="loader-section section-left"></div>
    <div class="loader-section section-right"></div>

</div>

<!--<div  class=" remove_node ui_cell AD1366599425" data-ui-name="dashboard" data-id="AD1366599425"><link href="lib/dashboard/zui.dashboard.min.css" rel="stylesheet">-->
<div id="dashboard" class="dashboard dashboard-draggable" data-height="580">
    <section class="row">
        <div class="col-xs-7 col-sm-7">
            <div class="panel" data-id="1" id="panel1" style="height: 580px;">
                <div class="panel-heading">
                    <i class="icon icon-film"></i>
                    <span class="title">视频</span>
                </div>
                <div class="panel-body ">
                    <div class="center-content page-container">

                        <div class="progress" id="loader">
                            <div class="indeterminate"></div>
                        </div>
                        <div style="position: relative" class="margin">
                            <video src="bbt.mp4" id="inputVideo" autoplay muted loop playsinline></video>
                            <canvas id="overlay" />
                        </div>

                        <div class="" style="margin-top: 5px">
                            <button onclick="next()" class="btn btn-info btn_next" type="button">下一视频/next</button>
                        </div>

                        <div style="width:380px;margin-left: 320px;margin-top:-210px;height: 220px;opacity: 0.6;z-index: 100" class="alert alert-warning alert-dismissable">
                            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                            <!--<script src="lib/zrender.min.js"></script>-->
                            <!--<script src="asset/js/esl/esl.js"></script>-->
                            <script src="lib/echarts.all.js"></script>
                            <style>
                                .chart_pie {
                                    height: 170px;
                                    margin: 0px;
                                    padding: 0px;
                                }
                                h5 {
                                    margin-top: 30px;
                                    font-weight: bold;
                                }
                                h5:first-child {
                                    margin-top: 15px;
                                }
                            </style>
                            <div class="">

                                <div class="chart_pie" id="chart_pie"></div>
                            </div>
                            <script>
                                var getOptionPie = function (chartType, dataScene) {
//            console.log("dataScene");
//            console.log(dataScene);
                                    var types = _.map(dataScene, function(item){return item.name});
//            console.log(types);
                                    var option = {
                                        backgroundColor:"#0B1837",
                                        color: ["#EAEA26", "#906BF9", "#FE5656", "#01E17E", "#3DD1F9", "#FFAD05"],
                                        // title: {
                                        //     text: '网络/安全设备',
                                        //     left: '60',
                                        //     top: 0,
                                        //     textAlign: 'center',
                                        //     textStyle: {
                                        //         color: '#fff',
                                        //         fontSize: 14,
                                        //         fontWeight: 0
                                        //     }
                                        // },
                                        grid: {
                                            left: -100,
                                            top: 50,
                                            bottom: 10,
                                            right: 10,
                                            containLabel: true
                                        },
                                        tooltip: {
                                            trigger: 'item',
                                            formatter: "{b} : {c} ({d}%)"
                                        },
                                        legend: {
                                            type: "scroll",
                                            orient: "vartical",
                                            // x: "right",
                                            top: "center",
                                            right: "15",
                                            // bottom: "0%",
                                            itemWidth: 16,
                                            itemHeight: 8,
                                            itemGap: 16,
                                            textStyle: {
                                                color: '#A3E2F4',
                                                fontSize: 12,
                                                fontWeight: 0
                                            },
                                            data: types
                                        },
                                        polar: {},
                                        angleAxis: {
                                            interval: 1,
                                            type: 'category',
                                            data: [],
                                            z: 10,
                                            axisLine: {
                                                show: false,
                                                lineStyle: {
                                                    color: "#0B4A6B",
                                                    width: 1,
                                                    type: "solid"
                                                },
                                            },
                                            axisLabel: {
                                                interval: 0,
                                                show: true,
                                                color: "#0B4A6B",
                                                margin: 8,
                                                fontSize: 16
                                            },
                                        },
                                        radiusAxis: {
                                            min: 40,
                                            max: 120,
                                            interval: 20,
                                            axisLine: {
                                                show: false,
                                                lineStyle: {
                                                    color: "#0B3E5E",
                                                    width: 1,
                                                    type: "solid"
                                                },
                                            },
                                            axisLabel: {
                                                formatter: '{value} %',
                                                show: false,
                                                padding: [0, 0, 20, 0],
                                                color: "#0B3E5E",
                                                fontSize: 16
                                            },
                                            splitLine: {
                                                lineStyle: {
                                                    color: "#0B3E5E",
                                                    width: 2,
                                                    type: "solid"
                                                }
                                            }
                                        },
                                        calculable: true,
                                        series: [{
                                            type: 'pie',
                                            radius: ["5%", "10%"],
                                            hoverAnimation: false,
                                            labelLine: {
                                                normal: {
                                                    show: false,
                                                    length: 30,
                                                    length2: 55
                                                },
                                                emphasis: {
                                                    show: false
                                                }
                                            },
                                            data: [{
                                                name: '',
                                                value: 0,
                                                itemStyle: {
                                                    normal: {
                                                        color: "#0B4A6B"
                                                    }
                                                }
                                            }]
                                        }, {
                                            type: 'pie',
                                            radius: ["90%", "95%"],
                                            hoverAnimation: false,
                                            labelLine: {
                                                normal: {
                                                    show: false,
                                                    length: 30,
                                                    length2: 55
                                                },
                                                emphasis: {
                                                    show: false
                                                }
                                            },
                                            name: "",
                                            data: [{
                                                name: '',
                                                value: 0,
                                                itemStyle: {
                                                    normal: {
                                                        color: "#0B4A6B"
                                                    }
                                                }
                                            }]
                                        },{
                                            stack: 'a',
                                            type: 'pie',
                                            radius: ['20%', '80%'],
                                            roseType: 'area',
                                            zlevel:10,
                                            label: {
                                                normal: {
                                                    show: true,
                                                    formatter: "{c}",
                                                    textStyle: {
                                                        fontSize: 12,
                                                    },
                                                    position: 'outside'
                                                },
                                                emphasis: {
                                                    show: true
                                                }
                                            },
                                            labelLine: {
                                                normal: {
                                                    show: true,
                                                    length: 20,
                                                    length2: 55
                                                },
                                                emphasis: {
                                                    show: false
                                                }
                                            },
                                            data: dataScene
                                        }, ]
                                    }

                                    return option;
                                };


                                byId("chart_pie").addEventListener('tap', function () {
                                    var url = this.getAttribute('data-url');
                                    if (window.plus) {
                                        plus.runtime.openURL(url);
                                    } else {
                                        window.open(url);
                                    }
                                }, false);
                            </script>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xs-5 col-sm-5">
            <div class="col-xs-6 col-sm-6">
                <div class="panel" data-id="left" id="panel_left" style="height: 420px;overflow: hidden">
                    <div class="no-padding ">
                        <div class="panel-group" id="accordion_left" aria-multiselectable="true">
                            <div class="panel panel-default">
                                <div class="panel-heading" id="headingOne">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#accordion_left" href="#collapse_result">
                                            <i class="icon icon-table"></i>
                                            <span class="title">分析结果描述/Analysis</span>
                                        </a>
                                    </h4>
                                </div>
                                <div id="collapse_result" class="panel-collapse collapse in">
                                        <div class="panel" data-id="3" id="panel3" style="height: 160px;">
                                            <div  class=" no-padding analysis_result animation" data-animation="fadeInUp" data-animation-delay="5.2s" style="font-size: 16px;">
                                            </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="panel-group" id="accordion_x" aria-multiselectable="true">


                        <div class="panel panel-default">
                            <div class="panel-heading" id="headingTwo">
                                <h4 class="panel-title">
                                    <a class="collapsed" data-toggle="collapse" data-parent="#accordionPanels"
                                       href="#collapse_safe">
                                        <i class="icon icon-bolt"></i>
                                        安全/alert
                                    </a>
                                </h4>
                            </div>
                            <div id="collapse_safe" class="panel-collapse collapse">
                                安全
                            </div>
                        </div>
                    </div>
                    </div>

                </div>

            </div>
            <div class="col-xs-6 col-sm-6">
                <div class="panel" data-id="2" id="panel2" style="height: 420px;overflow: hidden">

                    <div class=" no-padding ">
                        <div class="panel-group" id="accordionPanels" aria-multiselectable="true">

                            <div class="panel panel-default">
                                <div class="panel-heading" id="heading_atm">
                                    <h4 class="panel-title">
                                        <a class="collapsed" data-toggle="collapse" data-parent="#accordionPanels"
                                           href="#collapse_atm">
                                            <i class="icon icon-group"></i>氛围/atmosphere
                                        </a>
                                    </h4>
                                </div>
                                <div id="collapse_atm" class="panel-collapse collapse">
                                    <iframe id="my_frame" src="atm.html" width="100%" height="155" frameborder="0"></iframe>

                                </div>
                            </div>


                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading" id="headingThree">
                                <h4 class="panel-title">
                                    <a class="collapsed" data-toggle="collapse" data-parent="#accordionPanels"
                                       href="#collapse_tags">
                                        <i class="icon icon-tags"></i>
                                        <span class="title">标签/label</span>
                                    </a>
                                </h4>
                            </div>
                            <div id="collapse_tags" class="panel-collapse collapse">
                                    <div class="panel" data-id="4" id="panel4" style="height: 200px;">
                                        <div class=" rili_tag">
                                        </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>

            </div>

        </div>
        <div class="col-xs-4 col-sm-4" style="margin-top: -10px;height: 160px;
    width: 40%;">
            <div class="panel-body">
                <div class="panel" data-id="motion" id="panel_motion" style="height: 130px;">
                    <div class="panel-heading">
                        <i class="icon icon-table"></i>
                        <span class="title">情绪分析</span>
                    </div>
                    <div class="panel-body no-padding motion_analysis">
                    </div>
                </div>
            </div>

        </div>
        <!--<div class="col-xs-4">-->

            <!--<div class="resize-handle resize-horizontal"><i class="icon icon-resize-h"></i></div><div class="resize-handle resize-vertical"><i class="icon icon-resize-v"></i></div></div>-->
            <!--<div class="col-xs-4">-->
            <!--<div class="panel panel-error" data-id="5" data-url="partial/relation.html" id="panel5" style="height: 200px;">-->
            <!--<div class="panel-heading">-->
            <!--<i class="icon icon-globe"></i>-->
            <!--<span class="title">关系分析</span>-->
            <!--<div class="panel-actions">-->
            <!--<button type="button" class="btn refresh-panel" data-toggle="tooltip" title="重新从远程获取内容"><i class="icon-refresh"></i></button>-->
            <!--</div>-->
            <!--</div>-->
            <!--<div class="panel-body">等待加载内容。</div>-->
            <!--</div>-->
            <!--<div class="resize-handle resize-horizontal"><i class="icon icon-resize-h"></i></div><div class="resize-handle resize-vertical"><i class="icon icon-resize-v"></i></div></div>-->
            <!--<div class="col-xs-4 col-sm-6">-->
            <!--<div class="panel" data-id="6" id="panel6" style="height: 300px;">-->
            <!--<div class="panel-heading">-->
            <!--<div class="title">待开发</div>-->
            <!--<div class="panel-actions">-->
            <!--<button type="button" class="btn remove-panel" data-toggle="tooltip" title="移除面板"><i class="icon-remove"></i></button>-->
            <!--</div>-->
            <!--</div>-->
            <!--<div class="panel-body">-->
            <!--<p>哈哈 <i class="icon icon-chat-dot"></i> </p>-->
            <!--</div>-->
            <!--</div>-->
            <!--<div class="resize-handle resize-horizontal"><i class="icon icon-resize-h"></i></div><div class="resize-handle resize-vertical"><i class="icon icon-resize-v"></i></div></div>-->
            <!--<div class="col-xs-8 col-sm-6">-->
            <!--<div class="panel " data-id="6" id="panel7" style="height: 300px;">-->
            <!--<div class="panel-heading"><code>待开发</code></div>-->
            <!--<div class="panel-body">-->
            <!--哈哈哈哈-->
            <!--</div>-->
            <!--</div>-->
            <!--<div class="resize-handle resize-horizontal"><i class="icon icon-resize-h"></i></div><div class="resize-handle resize-vertical"><i class="icon icon-resize-v"></i></div></div>-->
    </section>
</div>
</div>

<script type="text/javascript" src="js/init.js"></script>
<script>
    let forwardTimes = []
    let withFaceLandmarks = false
    let withBoxes = true

    function onChangeWithFaceLandmarks(e) {
        withFaceLandmarks = $(e.target).prop('checked')
    }

    function onChangeHideBoundingBoxes(e) {
        withBoxes = !$(e.target).prop('checked')
    }

    function updateTimeStats(timeInMs) {
        forwardTimes = [timeInMs].concat(forwardTimes).slice(0, 30)
        const avgTimeInMs = forwardTimes.reduce((total, t) => total + t) / forwardTimes.length
        $('#time').val(`${Math.round(avgTimeInMs)} ms`)
        $('#fps').val(`${faceapi.round(1000 / avgTimeInMs)}`)
    }

    async function onPlay(videoEl) {
        if(!videoEl.currentTime || videoEl.paused || videoEl.ended || !isFaceDetectionModelLoaded())
            return setTimeout(() => onPlay(videoEl))


        const options = getFaceDetectorOptions()

        const ts = Date.now()

        const drawBoxes = withBoxes
        const drawLandmarks = withFaceLandmarks

        let task = faceapi.detectAllFaces(videoEl, options)
        task = withFaceLandmarks ? task.withFaceLandmarks() : task
        const results = await task

        updateTimeStats(Date.now() - ts)

        const canvas = $('#overlay').get(0)
        const dims = faceapi.matchDimensions(canvas, videoEl, true)

        const resizedResults = faceapi.resizeResults(results, dims)
        if (drawBoxes) {
            faceapi.draw.drawDetections(canvas, resizedResults)
        }
        if (drawLandmarks) {
            faceapi.draw.drawFaceLandmarks(canvas, resizedResults)
        }

        setTimeout(() => onPlay(videoEl))
    }

    async function run() {
        // load face detection and face landmark models
        await changeFaceDetector(TINY_FACE_DETECTOR)
        await faceapi.loadFaceLandmarkModel('/')
        changeInputSize(416)

        // start processing frames
        onPlay($('#inputVideo').get(0))
    }

    function updateResults() {}

    $(document).ready(function() {
        renderNavBar('#navbar', 'video_face_tracking')
        initFaceDetectionControls()
        run()
    })
</script>
</body>
</html>
